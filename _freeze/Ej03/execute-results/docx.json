{
  "hash": "2e61b5590c486979b17269095529b86b",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"High Plains Wheat Mosaic Virus (HPWMoV) en cultivos de maíz y trigo\"\nformat: docx\nself-contained: true \neditor: source\n---\n\n\n# Presentación de los Datos\n\n-   Se sistematizó información desde la primera detección en el pais del virus.\n\n-   Se generó un registro de presencia/ausencia georreferenciado según año y localidad de muestreo.\n\n-   Contamos con 169 observaciones para HPWMoV en maíz y 451 obsevaciones en trigo.\n\n-   Las observaciones no estan alineadas\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsuppressPackageStartupMessages({\nlibrary(sf)\nlibrary(dplyr)\nlibrary(tmap) \nlibrary(tidyr)\nlibrary(INLA)\nlibrary(inlabru)\nlibrary(ggplot2)\n})\nsource(\"src/spde-book-functions.R\")\ntmap_mode(\"view\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntrigo_maiz <- st_read(\"data/trigo_maiz_26_09_22.gpkg\",quiet = TRUE)\nst_geometry(trigo_maiz) <- 'geometry' \ntrigo_maiz$HPV <- as.factor(trigo_maiz$HPV)\n  \n\nhpv_maiz <- trigo_maiz |> \n  filter(Especie == \"Maíz\" & !is.na(HPV))\nhpv_maiz <-\n  hpv_maiz[!hpv_maiz$Provincia %in%\n              c('Catamarca',\n               'Santa Fe',\n               'Tucumán',\n               'Chaco',\n               'Santiago del Estero',\n               'San Luis','Jujuy'),]\n\n\nhpv_trigo <- trigo_maiz |> \n  filter(Especie == \"Trigo\" & !is.na(HPV)) \n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntm_shape(hpv_maiz)+\n  tm_dots(\"HPV\", title = \"HPV en Maiz\", pal = \"Dark2\" )+\n  tm_shape(hpv_trigo)+\n  tm_dots(\"HPV\", title = \"HPV en Trgio\", pal = \"Set1\")\n```\n:::\n\n\nComplementariamente, se obtuvieron 117 variables biometeorológicas, usando la plataforma ERA5, en el periodo comprendido entre agosto del año en que se tomo la muestra y agosto del año siguiente.\n\n# Selección de variables\n\nSe identificó la importancia de cada variable climática para cada patosistema con el algoritmo boruta y la selección de variables stepwise.\n\nLas variables biometeorológicas que favorecieron la presencia de HPWMoV en Maiz fueron las precipitaciones elevedas en el mes de Enero y temperatura de punto de rocio alta en el mes de Mayo\n\nEn trigo HPWMov se vio favorecido por precipitaciones elevadas en Enero y temperaturas bajas en Junio.\n\n# Modelación\n\nLa distribución de la presencia de estos virus se modeló con una regresión bayesiana de efectos mixtos y estructura espacial conjunta de las muestras sobre Trigo y Maíz estimada via SPDE considerando una malla común.\n\n<!-- $$ -->\n<!-- \\\\log{\\left(\\frac{p_{i.maíz}(S)}{1-p_{i.maiz}(S)}\\right)} = \\\\ -->\n<!-- \\alpha_{maíz} + x_{i1}(S)\\beta_{1.maíz} + x_{i2}(S)\\beta_{2.maíz} + x_{i3}(S)\\beta_{3.maíz} + Z_{maíz}(S) + e_{maíz}(S) -->\n<!-- $$ -->\n\n<!-- $$ -->\n<!-- \\\\log{\\left(\\frac{p_{i.trigo}(S)}{1-p_{i.trigo}(S)}\\right)} = \\\\ -->\n<!-- \\alpha_{trigo} + x_{i1}(S)\\beta_{4.trigo} + x_{i5}(S)\\beta_{5.trigo} + \\lambda Z_{maíz}(S) + Z_{trigo} (S) + e_{trigo} (S) -->\n<!-- $$ -->\n\ndonde $\\log{\\left(\\frac{p_ij}{1 - p_ij}\\right)}$ es la funcion de enlace. $x_1$ es el total de precipitaciones del mes de enero, $x_2$ es la temperatura punto rocío del mes de mayo y $x_3$ es el año en el que se tomo la muestra y $x_4$ es la temperatura del mes de junio. $Z$ es el efecto espacial\n\n## Armado del modelo\n\n### Cargamos la base de datos\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntrigo_hpv_sf2 <- st_read(\"data/trigo_hpv.gpkg\",quiet = TRUE)\nst_geometry(trigo_hpv_sf2) <- 'geometry'\n```\n:::\n\n\n### Cargamos los limites de la region donde hay datos\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlimites2 <- st_read(\"data/limites2.gpkg\", quiet = TRUE)\nst_geometry(limites2) <- 'geometry'\n```\n:::\n\n\n### Boundary\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbase_maiz <- trigo_hpv_sf2 |> \n  drop_na(HPV_maiz)\n\nbase_maiz <- base_maiz[!base_maiz$Provincia %in%\n              c('Catamarca',\n               'Santa Fe',\n               'Tucumán',\n               'Chaco',\n               'Santiago del Estero',\n               'San Luis','Jujuy'),]\n\nloc.maiz <- base_maiz |> \n  st_coordinates()\n\n\nbase_trigo <- trigo_hpv_sf2 |> \n  drop_na(HPV_trigo) \n\nloc.trigo <- base_trigo |> \n  st_coordinates()\n\nloc.obs <- rbind(st_coordinates(base_trigo),st_coordinates(base_maiz))\n\nboundary <- list(\n  inla.nonconvex.hull(loc.obs,2),\n  inla.nonconvex.hull(loc.obs, 4)\n)\n```\n:::\n\n\n### Mesh\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmesh <- inla.mesh.2d(boundary=boundary,\n                     max.edge=c(0.4, 0.8),\n                     min.angle=c(30, 21),\n                     max.n=c(480, 160), \n                     max.n.strict=c(128000, 128000),\n                     cutoff=0.03, \n                     offset=c(2, 4))\n\nplot(mesh)\npoints(loc.obs, pch=16, col=\"#FF5300\")\n```\n\n::: {.cell-output-display}\n![](Ej03_files/figure-docx/unnamed-chunk-7-1.png)\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(rbind(base_maiz,base_trigo)) + gg(mesh) + geom_sf()\n```\n\n::: {.cell-output-display}\n![](Ej03_files/figure-docx/unnamed-chunk-8-1.png)\n:::\n:::\n\n\n### SPDE - Modelo espacial\n\n\n::: {.cell}\n\n```{.r .cell-code}\nspde <- inla.spde2.pcmatern(\n  mesh = mesh,\n  prior.range = c(1000, 0.01), # P(range < rangemin) = 0.01\n  prior.sigma = c(10, 0.01))\n```\n:::\n\n\n### Formula\n\n\n::: {.cell}\n\n```{.r .cell-code}\nform <- y ~ -1 +\n  intercept_hpv_maiz+\n  intercept_hpv_trigo +\n  \n  Precipitacion_Jan_maiz + \n  Punto.rocio_May_maiz + \n  anio_maiz + \n  \n  Precipitacion_Jan_trigo + \n  Temperatura_Jun_trigo +\n  \n  f(s1, model = spde) + \n  f(s2, model = spde) + \n  f(s12, copy = \"s1\", fixed = FALSE)\n```\n:::\n\n\n### Matrices de Proyeccion\n\n\n::: {.cell}\n\n```{.r .cell-code}\nAmaiz <- inla.spde.make.A(mesh,loc.maiz)\n\nAtrigo <- inla.spde.make.A(mesh, loc.trigo)\n```\n:::\n\n\n### Stacks\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstackMaiz <- inla.stack(\n  data = list(y = cbind(NA, base_maiz$HPV_maiz)),\n  A = list(Amaiz,1),\n  effects = list(\n    list(s1 = 1:spde$n.spde),\n    list(intercept_hpv_trigo = rep(1, nrow(base_maiz)),\n         \n         Precipitacion_Jan_maiz  = base_maiz$Precipitacion_Jan,\n         Punto.rocio_May_maiz = base_maiz$Punto.rocio_May,\n         anio_maiz = base_maiz$Año.de.Colecta,\n         \n         Precipitacion_Jan_trigo  = rep(NA, nrow(base_maiz)),\n         Temperatura_Jun_trigo = rep(NA, nrow(base_maiz))\n         )\n    \n  ),\n  tag = \"WSMV_maiz\")\n\n\nstackTrigo <- inla.stack(\n  data =list(y = cbind(base_trigo$HPV_trigo,NA)),\n  A = list(Atrigo,1),\n  effects = list(\n    list(s2 = 1:spde$n.spde, s12 = 1:spde$n.spde),\n    list(intercept_hpv_maiz = rep(1, nrow(base_trigo)),\n         \n         Precipitacion_Jan_maiz  = rep(NA, nrow(base_trigo)),\n         Punto.rocio_May_maiz = rep(NA, nrow(base_trigo)),\n         anio_maiz = rep(NA, nrow(base_trigo)),\n         \n         Precipitacion_Jan_trigo = base_trigo$Precipitacion_Jan,\n         Temperatura_Jun_trigo = base_trigo$Temperatura_Jun \n           )\n  ),\n  tag = \"WSMV_trigo\")\n\n\nstack <- inla.stack(stackTrigo,stackMaiz)\n```\n:::\n\n\n### Resultados\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(123)\nresult <- inla(form,rep('binomial',2),\n               data = inla.stack.data(stack),\n               control.predictor = list(compute = TRUE,\n                                        A = inla.stack.A(stack), link = 1),\n               \n               control.compute = list(return.marginals=TRUE,\n                                      return.marginals.predictor=TRUE,\n                                      hyperpar=TRUE\n               )\n)\n\nresult$summary.fixed\n\nresult$summary.hyperpar\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n##                                mean          sd    0.025quant    0.5quant\n## intercept_hpv_maiz       0.44483371 31.56631725 -6.145366e+01  0.44485985\n## intercept_hpv_trigo     -0.77227914 31.63851540 -6.280320e+01 -0.77572026\n## Precipitacion_Jan_maiz   0.09595684  0.04896924 -6.692101e-05  0.09595680\n## Punto.rocio_May_maiz     0.10666160  0.06107754 -1.311174e-02  0.10666373\n## anio_maiz                0.05826551  0.03094871 -2.358982e-03  0.05823964\n## Precipitacion_Jan_trigo  0.23016345  0.05169582  1.287930e-01  0.23016349\n## Temperatura_Jun_trigo   -0.05816327  0.04097551 -1.385144e-01 -0.05816252\n##                          0.975quant        mode          kld\n## intercept_hpv_maiz      62.34317941  0.44485997 5.523604e-11\n## intercept_hpv_trigo     61.27821868 -0.77574246 4.990478e-11\n## Precipitacion_Jan_maiz   0.19198077  0.09595680 5.512891e-11\n## Punto.rocio_May_maiz     0.22642278  0.10666375 5.394904e-11\n## anio_maiz                0.11903656  0.05823931 1.754480e-10\n## Precipitacion_Jan_trigo  0.33153376  0.23016349 5.509943e-11\n## Temperatura_Jun_trigo    0.02218357 -0.05816251 5.484136e-11\n##                     mean           sd  0.025quant    0.5quant  0.975quant\n## Range for s1 2547.777048 152.06573372 2226.206032 2555.382163 2816.115084\n## Stdev for s1    3.111127   0.05013833    3.008244    3.112136    3.205816\n## Range for s2 2248.498991  42.82699148 2159.370682 2249.481660 2328.036662\n## Stdev for s2    3.159664   0.18996876    2.767984    3.165441    3.510100\n## Beta for s12    1.033401   0.01457428    1.010895    1.032196    1.066930\n##                     mode\n## Range for s1 2607.520766\n## Stdev for s1    3.119241\n## Range for s2 2257.708396\n## Stdev for s2    3.211526\n## Beta for s12    1.023482\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npar(mfrow = n2mfrow(length(names(result$marginals.fixed)), asp = 1))\ninvisible(\n  sapply(names(result$marginals.fixed), function(x) {\n    \n    plot(result$marginals.fixed[[x]], type = 'l', \n         xlab = x, ylab = 'Density')\n    abline(v = 0)\n  })\n)\n```\n\n::: {.cell-output-display}\n![](Ej03_files/figure-docx/unnamed-chunk-14-1.png)\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npar(mfrow = n2mfrow(length(names(result$marginals.hyperpar)), asp = 1))\nfor (j in names(result$marginals.hyperpar)) {\n  ii <- result$marginals.hyperpar[[j]][,2] > sqrt(.Machine$double.eps)\n  plot(result$marginals.hyperpar[[j]], \n       type = 'l', \n       xlim = range(result$marginals.hyperpar[[j]][ii, 1]), \n       xlab = names(result$marginals.hyperpar)[j], \n       ylab = 'Density',\n       main = j)\n}\n```\n\n::: {.cell-output-display}\n![](Ej03_files/figure-docx/unnamed-chunk-15-1.png)\n:::\n:::\n\n\nPara validar el modelo se realizó un validacion cruzada k-fold, con un k = 10, para cada cultivo.\n\nLos resultados indicaron que la modelación conjunta permitió aumentar la capacidad predictiva de la presencia de virus en el cultivo de trigo en relación al clima, respecto a la obtenida en el modelo marginal con las mismas regresoras.\n\n\n```{=html}\n<style type=\"text/css\">\n.tg  {border-collapse:collapse;border-spacing:0;}\n.tg td{border-style:solid;border-width:0px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;\n  padding:10px 5px;word-break:normal;}\n.tg th{border-style:solid;border-width:0px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;\n  overflow:hidden;padding:10px 5px;word-break:normal;}\n.tg .tg-mqa1{border-color:#000000;font-weight:bold;text-align:center;vertical-align:top}\n.tg .tg-mcqj{border-color:#000000;font-weight:bold;text-align:left;vertical-align:top}\n</style>\n```\n\n| HPWMoV |\n|--------|\n|        |\n|        |\n| Maíz   |\n| Trigo  |\n",
    "supporting": [
      "Ej03_files\\figure-docx"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}