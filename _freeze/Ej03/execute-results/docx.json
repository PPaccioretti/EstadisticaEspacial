{
  "hash": "3eeb1ac69e9683450af8bd76695a2844",
  "result": {
    "markdown": "---\ntitle: \"High Plains Wheat Mosaic Virus (HPWMoV) en cultivos de maíz y trigo\"\nformat: docx\nself-contained: true \neditor: source\n---\n\n\n# Presentación de los Datos\n\n-   Se sistematizó información desde la primera detección en el pais del virus.\n\n-   Se generó un registro de presencia/ausencia georreferenciado según año y localidad de muestreo.\n\n-   Contamos con 169 observaciones para HPWMoV en maíz y 451 obsevaciones en trigo.\n\n-   Las observaciones no estan alineadas\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsuppressPackageStartupMessages({\nlibrary(sf)\nlibrary(dplyr)\nlibrary(tmap) \nlibrary(tidyr)\nlibrary(INLA)\nlibrary(inlabru)\nlibrary(ggplot2)\n})\nsource(\"src/spde-book-functions.R\")\ntmap_mode(\"view\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntrigo_maiz <- st_read(\"data/trigo_maiz_26_09_22.gpkg\",quiet = TRUE)\nst_geometry(trigo_maiz) <- 'geometry' \ntrigo_maiz$HPV <- as.factor(trigo_maiz$HPV)\n  \n\nhpv_maiz <- trigo_maiz |> \n  filter(Especie == \"Maíz\" & !is.na(HPV))\nhpv_maiz <-\n  hpv_maiz[!hpv_maiz$Provincia %in%\n              c('Catamarca',\n               'Santa Fe',\n               'Tucumán',\n               'Chaco',\n               'Santiago del Estero',\n               'San Luis','Jujuy'),]\n\n\nhpv_trigo <- trigo_maiz |> \n  filter(Especie == \"Trigo\" & !is.na(HPV)) \n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntm_shape(hpv_maiz)+\n  tm_dots(\"HPV\", title = \"HPV en Maiz\", pal = \"Dark2\" )+\n  tm_shape(hpv_trigo)+\n  tm_dots(\"HPV\", title = \"HPV en Trgio\", pal = \"Set1\")\n```\n\n::: {.cell-output-display}\n![](Ej03_files/figure-docx/unnamed-chunk-3-1.png)\n:::\n:::\n\n\nComplementariamente, se obtuvieron 117 variables biometeorológicas, usando la plataforma ERA5, en el periodo comprendido entre agosto del año en que se tomo la muestra y agosto del año siguiente.\n\n# Selección de variables\n\nSe identificó la importancia de cada variable climática para cada patosistema con el algoritmo boruta y la selección de variables stepwise.\n\nLas variables biometeorológicas que favorecieron la presencia de HPWMoV en Maiz fueron las precipitaciones elevedas en el mes de Enero y temperatura de punto de rocio alta en el mes de Mayo\n\nEn trigo HPWMov se vio favorecido por precipitaciones elevadas en Enero y temperaturas bajas en Junio.\n\n# Modelación\n\nLa distribución de la presencia de estos virus se modeló con una regresión bayesiana de efectos mixtos y estructura espacial conjunta de las muestras sobre Trigo y Maíz estimada via SPDE considerando una malla común.\n\n$$\n\\log{\\left(\\frac{p_{i.maíz}(S)}{1-p_{i.maiz}(S)}\\right)} = \\\\\n\\alpha_{maíz} + x_{i1}(S)\\beta_{1.maíz} + x_{i2}(S)\\beta_{2.maíz} + x_{i3}(S)\\beta_{3.maíz} +\nZ_{maíz}(S) + e_{maíz}(S)\n$$\n\n$$\n\\log{\\left(\\frac{p_{i.trigo}(S)}{1-p_{i.trigo}(S)}\\right)} = \\\\\n\\alpha_{trigo} + x_{i1}(S)\\beta_{4.trigo} + x_{i5}(S)\\beta_{5.trigo} + \\lambda Z_{maíz}(S) +\nZ_{trigo} (S) + e_{trigo} (S)\n$$\n\ndonde $\\log{\\left(\\frac{p_ij}{1 - p_ij}\\right)}$ es la funcion de enlace. $x_1$ es el total de precipitaciones del mes de enero, $x_2$ es la temperatura punto rocío del mes de mayo y $x_3$ es el año en el que se tomo la muestra y $x_4$ es la temperatura del mes de junio. $Z$ es el efecto espacial\n\n## Armado del modelo\n\n### Cargamos la base de datos\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntrigo_hpv_sf2 <- st_read(\"data/trigo_hpv.gpkg\",quiet = TRUE)\nst_geometry(trigo_hpv_sf2) <- 'geometry'\n```\n:::\n\n\n### Cargamos los limites de la region donde hay datos\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlimites2 <- st_read(\"data/limites2.gpkg\", quiet = TRUE)\nst_geometry(limites2) <- 'geometry'\n```\n:::\n\n\n### Boundary\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbase_maiz <- trigo_hpv_sf2 |> \n  drop_na(HPV_maiz)\n\nbase_maiz <- base_maiz[!base_maiz$Provincia %in%\n              c('Catamarca',\n               'Santa Fe',\n               'Tucumán',\n               'Chaco',\n               'Santiago del Estero',\n               'San Luis','Jujuy'),]\n\nloc.maiz <- base_maiz |> \n  st_coordinates()\n\n\nbase_trigo <- trigo_hpv_sf2 |> \n  drop_na(HPV_trigo) \n\nloc.trigo <- base_trigo |> \n  st_coordinates()\n\nloc.obs <- rbind(st_coordinates(base_trigo),st_coordinates(base_maiz))\n\nboundary <- list(\n  inla.nonconvex.hull(loc.obs,2),\n  inla.nonconvex.hull(loc.obs, 4)\n)\n```\n:::\n\n\n### Mesh\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmesh <- inla.mesh.2d(boundary=boundary,\n                     max.edge=c(0.4, 0.8),\n                     min.angle=c(30, 21),\n                     max.n=c(480, 160), \n                     max.n.strict=c(128000, 128000),\n                     cutoff=0.03, \n                     offset=c(2, 4))\n\nplot(mesh)\npoints(loc.obs, pch=16, col=\"#FF5300\")\n```\n\n::: {.cell-output-display}\n![](Ej03_files/figure-docx/unnamed-chunk-7-1.png)\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(rbind(base_maiz,base_trigo)) + gg(mesh) + geom_sf()\n```\n\n::: {.cell-output-display}\n![](Ej03_files/figure-docx/unnamed-chunk-8-1.png)\n:::\n:::\n\n\n### SPDE - Modelo espacial\n\n\n::: {.cell}\n\n```{.r .cell-code}\nspde <- inla.spde2.pcmatern(\n  mesh = mesh,\n  prior.range = c(1000, 0.01), # P(range < rangemin) = 0.01\n  prior.sigma = c(10, 0.01))\n```\n:::\n\n\n### Formula\n\n\n::: {.cell}\n\n```{.r .cell-code}\nform <- y ~ -1 +\n  intercept_hpv_maiz+\n  intercept_hpv_trigo +\n  \n  Precipitacion_Jan_maiz + \n  Punto.rocio_May_maiz + \n  anio_maiz + \n  \n  Precipitacion_Jan_trigo + \n  Temperatura_Jun_trigo +\n  \n  f(s1, model = spde) + \n  f(s2, model = spde) + \n  f(s12, copy = \"s1\", fixed = FALSE)\n```\n:::\n\n\n### Matrices de Proyeccion\n\n\n::: {.cell}\n\n```{.r .cell-code}\nAmaiz <- inla.spde.make.A(mesh,loc.maiz)\n\nAtrigo <- inla.spde.make.A(mesh, loc.trigo)\n```\n:::\n\n\n### Stacks\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstackMaiz <- inla.stack(\n  data = list(y = cbind(NA, base_maiz$HPV_maiz)),\n  A = list(Amaiz,1),\n  effects = list(\n    list(s1 = 1:spde$n.spde),\n    list(intercept_hpv_trigo = rep(1, nrow(base_maiz)),\n         \n         Precipitacion_Jan_maiz  = base_maiz$Precipitacion_Jan,\n         Punto.rocio_May_maiz = base_maiz$Punto.rocio_May,\n         anio_maiz = base_maiz$Año.de.Colecta,\n         \n         Precipitacion_Jan_trigo  = rep(NA, nrow(base_maiz)),\n         Temperatura_Jun_trigo = rep(NA, nrow(base_maiz))\n         )\n    \n  ),\n  tag = \"WSMV_maiz\")\n\n\nstackTrigo <- inla.stack(\n  data =list(y = cbind(base_trigo$HPV_trigo,NA)),\n  A = list(Atrigo,1),\n  effects = list(\n    list(s2 = 1:spde$n.spde, s12 = 1:spde$n.spde),\n    list(intercept_hpv_maiz = rep(1, nrow(base_trigo)),\n         \n         Precipitacion_Jan_maiz  = rep(NA, nrow(base_trigo)),\n         Punto.rocio_May_maiz = rep(NA, nrow(base_trigo)),\n         anio_maiz = rep(NA, nrow(base_trigo)),\n         \n         Precipitacion_Jan_trigo = base_trigo$Precipitacion_Jan,\n         Temperatura_Jun_trigo = base_trigo$Temperatura_Jun \n           )\n  ),\n  tag = \"WSMV_trigo\")\n\n\nstack <- inla.stack(stackTrigo,stackMaiz)\n```\n:::\n\n\n### Resultados\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(123)\nresult <- inla(form,rep('binomial',2),\n               data = inla.stack.data(stack),\n               control.predictor = list(compute = TRUE,\n                                        A = inla.stack.A(stack), link = 1),\n               \n               control.compute = list(return.marginals=TRUE,\n                                      return.marginals.predictor=TRUE,\n                                      hyperpar=TRUE\n               )\n)\n\nresult$summary.fixed\n\nresult$summary.hyperpar\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n##                                mean          sd    0.025quant    0.5quant\n## intercept_hpv_maiz       3.06244626 31.36089955 -58.526863592  3.09517858\n## intercept_hpv_trigo     -5.97251121 31.15178850 -66.898170482 -6.02897370\n## Precipitacion_Jan_maiz   0.09609822  0.04876401   0.002190707  0.09548135\n## Punto.rocio_May_maiz     0.11535072  0.06066441  -0.002599736  0.11498833\n## anio_maiz                0.04787371  0.02907662  -0.007416195  0.04741078\n## Precipitacion_Jan_trigo  0.23154670  0.05128397   0.133259474  0.23072643\n## Temperatura_Jun_trigo   -0.05207521  0.04043054  -0.131122272 -0.05216150\n##                          0.975quant        mode          kld\n## intercept_hpv_maiz      64.46870378  3.16263383 1.149682e-09\n## intercept_hpv_trigo     55.26916850 -6.14506852 4.523306e-09\n## Precipitacion_Jan_maiz   0.19351269  0.09426913 7.407073e-09\n## Punto.rocio_May_maiz     0.23536205  0.11427451 3.489276e-07\n## anio_maiz                0.10589597  0.04652766 2.666798e-07\n## Precipitacion_Jan_trigo  0.33449640  0.22911637 1.428071e-07\n## Temperatura_Jun_trigo    0.02746117 -0.05233298 9.724779e-07\n##                     mean           sd   0.025quant     0.5quant  0.975quant\n## Range for s1 3212.387972 1420.8880486 1290.8249188 2933.0193750 6773.583940\n## Stdev for s1    1.003311    0.7411048    0.2140887    0.8083059    2.956980\n## Range for s2 2985.392907 1039.6203823 1457.3682005 2813.8648039 5546.138954\n## Stdev for s2    1.064914    0.7093357    0.2692509    0.8861555    2.923663\n## Beta for s12    0.966747    0.3361185    0.3064591    0.9641206    1.644808\n##                      mode\n## Range for s1 2449.9324574\n## Stdev for s1    0.5180448\n## Range for s2 2496.3102208\n## Stdev for s2    0.6142042\n## Beta for s12    0.9527771\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npar(mfrow = n2mfrow(length(names(result$marginals.fixed)), asp = 1))\ninvisible(\n  sapply(names(result$marginals.fixed), function(x) {\n    \n    plot(result$marginals.fixed[[x]], type = 'l', \n         xlab = x, ylab = 'Density')\n    abline(v = 0)\n  })\n)\n```\n\n::: {.cell-output-display}\n![](Ej03_files/figure-docx/unnamed-chunk-14-1.png)\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npar(mfrow = n2mfrow(length(names(result$marginals.hyperpar)), asp = 1))\nfor (j in names(result$marginals.hyperpar)) {\n  ii <- result$marginals.hyperpar[[j]][,2] > sqrt(.Machine$double.eps)\n  plot(result$marginals.hyperpar[[j]], \n       type = 'l', \n       xlim = range(result$marginals.hyperpar[[j]][ii, 1]), \n       xlab = names(result$marginals.hyperpar)[j], \n       ylab = 'Density',\n       main = j)\n}\n```\n\n::: {.cell-output-display}\n![](Ej03_files/figure-docx/unnamed-chunk-15-1.png)\n:::\n:::\n\n\nPara validar el modelo se realizó un validacion cruzada k-fold, con un k = 10, para cada cultivo.\n\nLos resultados indicaron que la modelación conjunta permitió aumentar la capacidad predictiva de la presencia de virus en el cultivo de trigo en relación al clima, respecto a la obtenida en el modelo marginal con las mismas regresoras.\n\n\n```{=html}\n<style type=\"text/css\">\n.tg  {border-collapse:collapse;border-spacing:0;}\n.tg td{border-style:solid;border-width:0px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;\n  padding:10px 5px;word-break:normal;}\n.tg th{border-style:solid;border-width:0px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;\n  overflow:hidden;padding:10px 5px;word-break:normal;}\n.tg .tg-mqa1{border-color:#000000;font-weight:bold;text-align:center;vertical-align:top}\n.tg .tg-mcqj{border-color:#000000;font-weight:bold;text-align:left;vertical-align:top}\n</style>\n```\n\n| HPWMoV |\n|--------|\n|        |\n|        |\n| Maíz   |\n| Trigo  |\n",
    "supporting": [
      "Ej03_files\\figure-docx"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}