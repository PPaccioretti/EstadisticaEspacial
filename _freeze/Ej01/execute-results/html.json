{
  "hash": "e88636e5352350ec9397c0f7a044131d",
  "result": {
    "markdown": "---\ntitle: \"Ejemplo 1: Modelación del rendimiento de caña de azúcar a partir de información satelital\"\nformat: html\n---\n\n\n## Motivación \n\nLa generación de datos a partir de imágenes satelitales, constituyen una fuente \nvaliosa de información, pudiéndose construir incluso series históricas de \nimagen de un sitio. En bioestadística este tipo de datos se usa para monitorear \necosistemas, realizar pronósticos climáticos y predecir cosechas, entre otros.\n\nEn este caso mostramos la implementación de un análisis exploratorio de datos \npara caracterizar la variable toneladas de caña por hectárea. \nLuego estudiaremos el uso de modelos de regresión lineal para estimar \nrendimientos de caña de azúcar a partir de índices de vegetación elaborados \ncon información proveniente de sensores remotos.\n\n\n## Datos\n\nTrabajamos con datos de imágenes del satélite Landsat 5 TM, \nseleccionadas desde: USGS (USA): <http://earthexplorer.usgs.gov/> e \nINPE (Brasil): <http://www.inpe.br/>.\n\nSe utilizaron datos pertenecientes a lotes de producción de caña de azúcar \ndel noroeste argentino, expresados en toneladas de caña por hectárea (TCH) \npor lote, correspondientes a la zafra de 2009. Se eligieron 79 lotes con fecha \nde cosecha posterior a la fecha de la imagen satelital y se registraron los \nvalores de TCH y las bandas de la imagen que seria usadas para predecir esa \nTCH. Todas los lotes fueron cosechado en verde (i.e. no-quema). De cada lote \nse registró además la edad del cultivo ya que la caña de azúcar es una especie \nsemiperenne y algunos lotes eran del primer año de plantación (caña planta), \nmientras que otros del segundo año o primer rebrote (soca1) y otros de \nrebrotes de 2 o más años desde la plantación (entre paréntesis figura el nombre \nde la variable en el archivo de datos)\n\n- Unidad de análisis (UM)\n- Longitud (X_coord)      \n- Latitud (Y_coord)      \n- Banda 1 de la imagen satelital (Banda1)      \n- Banda 2 de la imagen satelital (Banda2)        \n- Banda 3 de la imagen satelital (Banda3)      \n- Banda 4 de la imagen satelital (Banda4)         \n- Banda 5 de la imagen satelital (Banda5)      \n- Banda 7 de la imagen satelital (Banda7)      \n- Edad en dos categorías: \"Planta o Soca1\" y \"Soca2 o más\" (EDAD)\n- Toneladas de caña por ha (TCH)             \n\n### Lectura base de datos\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Carga paquetes y funciones\"}\nlibrary(nlme)\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(sf)\nlibrary(tmap)\n\n\nresumir_modelo <- function(modelo) {\n  \n  rmse <- function(modelo) {\n    sqrt(mean(modelo$residuals^2))\n  }\n  \n  aic <- AIC(modelo)\n  bic <- BIC(modelo)\n  my_rmse <- rmse(modelo)\n  regresora <- paste(attr(modelo$terms,\"term.labels\"), collapse = \", \")\n  \n  conCor <- ifelse(length(modelo$modelStruct), 'Si', 'No')\n  data.frame('Indice' = regresora,\n             'ConCorr' = conCor,\n             'AIC' = aic,\n             'BIC' = bic,\n             'RMSE' = my_rmse, \n             check.names = FALSE)\n}\n\ndiferenciaNormalizada <- function(x, y) {\n  (x - y) / (x + y)\n}\n\n# tmap::tmap_options(basemap.server = c(\n#   'Satelital' = leaflet::providers$Esri.WorldImagery,\n#   'OSM' = leaflet::providers$OpenStreetMap))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndatos <- read.table(\"data/No_quemadas.txt\")\n```\n:::\n\n\n### Cálculos de índices a partir de las bandas\n\n\n-  Índice de Vegetación de Diferencia Normalizada (Normalized Difference \nVegetation Index, NDVI)\n\n\n::: {.callout-noet appearance=\"simple\"}\n\nEl cálculo del NDVI se basa en la combinación de las bandas 3 (R) y 4 (NIR) de\nlansat ya que las plantas absorben la luz correspondiente a dichas bandas \ndiferencialmente según su estado vegetativo.\n\n:::\n\n\n\n\n$$NDVI = \\frac{NIR - R}{NIR + R} =  \\frac{B4 - B3}{B4 + B3}$$\n\n- NDVI verde (green NDVI, gNDVI). Permite capturar más específicamente la \nconcentración de clorofila. \n\n\n$$gNDVI = \\frac{NIR - G}{NIR + G} =  \\frac{B4 - B2}{B4 + B2}$$\n\n- Índice de Canopeo Normalizado (Normalized Canopy Index, NCI), \nrelacionado con el área foliar. Mayores valores de NCI indican menor área foliar\ny mayor cantidad de suelo desnudo, es decir menor canopeo.\n\n\n$$NCI = \\frac{SWIR - G}{SWIR + G} =  \\frac{B5 - B2}{B5 + B2}$$\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndatos <- datos |> \n  mutate(\n    ndvi = diferenciaNormalizada(Banda4, Banda3),\n    gndvi = diferenciaNormalizada(Banda4, Banda2),\n    nci = diferenciaNormalizada(Banda5, Banda2)\n  )\n```\n:::\n\n\n### Visualización espacial de los datos\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndatos_sf <-\n  sf::st_as_sf(datos,\n               coords = c('X_coord', 'Y_coord'),\n               crs = 32720)\n\ntmap_mode('view')\n```\n:::\n\n\n\n:::: {.columns}\n\n::: {.column width=\"49%\"}\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntm_shape(datos_sf) +\n  tm_dots(fill = 'TCH',\n          fill.scale = tm_scale_continuous(values = \"carto.ag_grn_yl\"),\n          size = 0.5)\n```\n:::\n\n\n:::\n\n::: {.column width=\"2%\"}\n\n:::\n\n\n::: {.column width=\"49%\"}\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntm_shape(datos_sf) +\n  tm_dots(fill = 'ndvi',\n          fill.scale = tm_scale_continuous(values = \"tableau.classic_green\"),\n          size = 0.5)\n```\n:::\n\n\n\n:::\n\n::::\n\n\n\n\n### Estadística descriptiva\n\n#### Gráficos\n\n\n\n::: {.cell layout-ncol=\"2\"}\n\n```{.r .cell-code}\nggplot(datos, aes(TCH)) +\n  geom_histogram(aes(y = after_stat(count / sum(count))),\n                 bins = 15) +\n  labs(y = 'Frecuencia Relativa')\n\nggplot(datos, aes(EDAD, TCH)) +\n  geom_boxplot(width = 0.25)\n```\n\n::: {.cell-output-display}\n![Histograma](Ej01_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n\n::: {.cell-output-display}\n![Gráfico de cajas](Ej01_files/figure-html/unnamed-chunk-7-2.png){width=672}\n:::\n:::\n\n\n\n\n### Análisis de regresión Lineal\n\n#### NDVI\n\n::: {.column-margin}\n\n\n::: {.cell .column-margin}\n\n```{.r .cell-code}\nggplot(datos, aes(ndvi, TCH)) +\n  geom_point()\n```\n\n::: {.cell-output-display}\n![TCH en función de NDVI](Ej01_files/figure-html/fig-ndvi-1.png){#fig-ndvi width=672}\n:::\n:::\n\n\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodelo_ndvi <- gls(TCH ~ ndvi, \n                   data = datos, \n                   method = 'REML')\nsummary(modelo_ndvi)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n## Generalized least squares fit by REML\n##   Model: TCH ~ ndvi \n##   Data: datos \n##        AIC     BIC    logLik\n##   630.4788 637.471 -312.2394\n## \n## Coefficients:\n##                 Value Std.Error   t-value p-value\n## (Intercept) -116.3873  33.64212 -3.459570   9e-04\n## ndvi         314.9360  51.70535  6.090974   0e+00\n## \n##  Correlation: \n##      (Intr)\n## ndvi -0.999\n## \n## Standardized residuals:\n##         Min          Q1         Med          Q3         Max \n## -2.08695971 -0.57298217 -0.01604275  0.55538562  2.81179426 \n## \n## Residual standard error: 14.54863 \n## Degrees of freedom: 78 total; 76 residual\n```\n:::\n:::\n\n\n\n\n\n#### gNDVI\n\n::: {.column-margin}\n\n\n::: {.cell .column-margin}\n\n```{.r .cell-code}\nggplot(datos, aes(gndvi, TCH)) +\n  geom_point()\n```\n\n::: {.cell-output-display}\n![TCH en función de gNDVI](Ej01_files/figure-html/fig-gndvi-1.png){#fig-gndvi width=672}\n:::\n:::\n\n\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodelo_gndvi <- gls(TCH ~ gndvi, \n                    data = datos, \n                    method = 'REML')\nsummary(modelo_gndvi)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n## Generalized least squares fit by REML\n##   Model: TCH ~ gndvi \n##   Data: datos \n##        AIC      BIC    logLik\n##   629.1229 636.1151 -311.5614\n## \n## Coefficients:\n##                 Value Std.Error   t-value p-value\n## (Intercept) -165.8848  41.21302 -4.025058   1e-04\n## gndvi        448.9050  72.73257  6.171994   0e+00\n## \n##  Correlation: \n##       (Intr)\n## gndvi -0.999\n## \n## Standardized residuals:\n##           Min            Q1           Med            Q3           Max \n## -2.0868227416 -0.4850732735  0.0006377955  0.5531917024  2.8270446735 \n## \n## Residual standard error: 14.48515 \n## Degrees of freedom: 78 total; 76 residual\n```\n:::\n:::\n\n\n#### NCI \n\n::: {.column-margin}\n\n\n::: {.cell .column-margin}\n\n```{.r .cell-code}\nggplot(datos, aes(nci, TCH)) +\n  geom_point()\n```\n\n::: {.cell-output-display}\n![TCH en función de NCI](Ej01_files/figure-html/fig-nci-1.png){#fig-nci width=672}\n:::\n:::\n\n\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodelo_nci <-  gls(TCH ~ nci, \n                   data = datos, \n                   method = 'REML')\nsummary(modelo_nci)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n## Generalized least squares fit by REML\n##   Model: TCH ~ nci \n##   Data: datos \n##        AIC      BIC   logLik\n##   638.6299 645.6221 -316.315\n## \n## Coefficients:\n##                 Value Std.Error   t-value p-value\n## (Intercept)  275.5376  38.31946  7.190539       0\n## nci         -504.6346 103.15799 -4.891861       0\n## \n##  Correlation: \n##     (Intr)\n## nci -0.999\n## \n## Standardized residuals:\n##          Min           Q1          Med           Q3          Max \n## -2.273389964 -0.534774349 -0.004252205  0.635330715  2.195348983 \n## \n## Residual standard error: 15.47764 \n## Degrees of freedom: 78 total; 76 residual\n```\n:::\n:::\n\n\n\n### Resumen de modelos ajustados\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrbind(\n  resumir_modelo(modelo_ndvi),\n  resumir_modelo(modelo_gndvi),\n  resumir_modelo(modelo_nci)\n  )\n```\n\n::: {.cell-output-display}\n<div class=\"kable-table\">\n\n|Indice |ConCorr |      AIC|      BIC|     RMSE|\n|:------|:-------|--------:|--------:|--------:|\n|ndvi   |No      | 630.4788| 637.4710| 14.36090|\n|gndvi  |No      | 629.1229| 636.1151| 14.29823|\n|nci    |No      | 638.6299| 645.6221| 15.27792|\n\n</div>\n:::\n:::\n\n\n\n## Ajuste espacial\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodelo_ndvi_conCorr <- gls(\n  TCH ~ ndvi,\n  correlation = corExp(\n    form =  ~ as.numeric(as.character(X_coord)) + \n      as.numeric(as.character(Y_coord)),\n    metric = \"euclidean\",\n    nugget = FALSE\n  ),\n  data = datos,\n  method = 'REML'\n)\nsummary(modelo_ndvi_conCorr)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n## Generalized least squares fit by REML\n##   Model: TCH ~ ndvi \n##   Data: datos \n##        AIC      BIC    logLik\n##   627.2496 636.5725 -309.6248\n## \n## Correlation Structure: Exponential spatial correlation\n##  Formula: ~as.numeric(as.character(X_coord)) + as.numeric(as.character(Y_coord)) \n##  Parameter estimate(s):\n##    range \n## 1229.264 \n## \n## Coefficients:\n##                 Value Std.Error   t-value p-value\n## (Intercept) -99.12808  35.03923 -2.829060   0.006\n## ndvi        285.90429  54.01696  5.292862   0.000\n## \n##  Correlation: \n##      (Intr)\n## ndvi -0.997\n## \n## Standardized residuals:\n##         Min          Q1         Med          Q3         Max \n## -1.87668595 -0.40251825  0.08934825  0.64328353  2.65467052 \n## \n## Residual standard error: 15.95641 \n## Degrees of freedom: 78 total; 76 residual\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmodelo_gndvi_conCorr <- gls(\n  TCH ~ gndvi,\n  correlation = corExp(\n    form =  ~ as.numeric(as.character(X_coord)) + \n      as.numeric(as.character(Y_coord)),\n    metric = \"euclidean\",\n    nugget = FALSE\n  ),\n  data = datos,\n  method = 'REML'\n)\nsummary(modelo_gndvi_conCorr)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n## Generalized least squares fit by REML\n##   Model: TCH ~ gndvi \n##   Data: datos \n##        AIC      BIC    logLik\n##   623.8545 633.1774 -307.9273\n## \n## Correlation Structure: Exponential spatial correlation\n##  Formula: ~as.numeric(as.character(X_coord)) + as.numeric(as.character(Y_coord)) \n##  Parameter estimate(s):\n##    range \n## 1339.352 \n## \n## Coefficients:\n##                 Value Std.Error   t-value p-value\n## (Intercept) -154.9457  42.98948 -3.604269   6e-04\n## gndvi        425.7714  75.95467  5.605598   0e+00\n## \n##  Correlation: \n##       (Intr)\n## gndvi -0.998\n## \n## Standardized residuals:\n##        Min         Q1        Med         Q3        Max \n## -1.7304645 -0.2923111  0.1405291  0.6403081  2.6966424 \n## \n## Residual standard error: 15.95296 \n## Degrees of freedom: 78 total; 76 residual\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmodelo_nci_conCorr <- gls(\n  TCH ~ nci,\n  correlation = corExp(\n    form =  ~ as.numeric(as.character(X_coord)) +\n      as.numeric(as.character(Y_coord)),\n    metric = \"euclidean\",\n    nugget = FALSE\n  ),\n  data = datos,\n  method = 'REML'\n)\nsummary(modelo_nci_conCorr)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n## Generalized least squares fit by REML\n##   Model: TCH ~ nci \n##   Data: datos \n##        AIC      BIC    logLik\n##   636.5002 645.8232 -314.2501\n## \n## Correlation Structure: Exponential spatial correlation\n##  Formula: ~as.numeric(as.character(X_coord)) + as.numeric(as.character(Y_coord)) \n##  Parameter estimate(s):\n##    range \n## 791.3094 \n## \n## Coefficients:\n##                 Value Std.Error   t-value p-value\n## (Intercept)  257.4790  40.85657  6.302023   0e+00\n## nci         -457.4087 109.32719 -4.183851   1e-04\n## \n##  Correlation: \n##     (Intr)\n## nci -0.998\n## \n## Standardized residuals:\n##        Min         Q1        Med         Q3        Max \n## -2.1177676 -0.5221233  0.0235839  0.6875554  2.1389684 \n## \n## Residual standard error: 15.97278 \n## Degrees of freedom: 78 total; 76 residual\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nrbind(\n  resumir_modelo(modelo_ndvi),\n  resumir_modelo(modelo_ndvi_conCorr),\n  resumir_modelo(modelo_gndvi),\n  resumir_modelo(modelo_gndvi_conCorr),\n  resumir_modelo(modelo_nci),\n  resumir_modelo(modelo_nci_conCorr)\n  )\n```\n\n::: {.cell-output-display}\n<div class=\"kable-table\">\n\n|Indice |ConCorr |      AIC|      BIC|     RMSE|\n|:------|:-------|--------:|--------:|--------:|\n|ndvi   |No      | 630.4788| 637.4710| 14.36090|\n|ndvi   |Si      | 627.2496| 636.5725| 14.48017|\n|gndvi  |No      | 629.1229| 636.1151| 14.29823|\n|gndvi  |Si      | 623.8545| 633.1774| 14.46971|\n|nci    |No      | 638.6299| 645.6221| 15.27792|\n|nci    |Si      | 636.5002| 645.8232| 15.30830|\n\n</div>\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nef_fijos_ndvo_iid <- summary(modelo_ndvi)\nef_fijos_ndvo_iid$tTable\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n##                 Value Std.Error   t-value      p-value\n## (Intercept) -116.3873  33.64212 -3.459570 8.903363e-04\n## ndvi         314.9360  51.70535  6.090974 4.273028e-08\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nef_fijos_ndvo_corr <- summary(modelo_ndvi_conCorr)\nef_fijos_ndvo_corr$tTable\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n##                 Value Std.Error   t-value      p-value\n## (Intercept) -99.12808  35.03923 -2.829060 5.967466e-03\n## ndvi        285.90429  54.01696  5.292862 1.128048e-06\n```\n:::\n:::\n\n::: {.cell .column-page layout-nrow=\"1\" layout-ncol=\"3\"}\n\n```{.r .cell-code}\npredichos_lm <- datos\npredichos_lm$pred_ndvi_iid <- predict(modelo_ndvi)\npredichos_lm$pred_ndvi_esp <- predict(modelo_ndvi_conCorr)\n\n\nggplot(predichos_lm, aes(pred_ndvi_iid, TCH)) +\n  geom_point() +\n  geom_abline(slope = 1, intercept = 0)\n```\n\n::: {.cell-output-display}\n![](Ej01_files/figure-html/obs-pred-lm-1.png){width=672}\n:::\n\n```{.r .cell-code}\nggplot(predichos_lm, aes(pred_ndvi_esp, TCH)) +\n  geom_point() +\n  geom_abline(slope = 1, intercept = 0)\n```\n\n::: {.cell-output-display}\n![](Ej01_files/figure-html/obs-pred-lm-2.png){width=672}\n:::\n\n```{.r .cell-code}\nggplot(predichos_lm, aes(pred_ndvi_esp, pred_ndvi_iid)) +\n  geom_point() +\n  geom_abline(slope = 1, intercept = 0)\n```\n\n::: {.cell-output-display}\n![](Ej01_files/figure-html/obs-pred-lm-3.png){width=672}\n:::\n:::\n\n\n\n# INLA\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# if (!requireNamespace(\"BiocManager\", quietly = TRUE))\n#   install.packages(\"BiocManager\")\n# BiocManager::install(c(\"graph\", \"Rgraphviz\"), dep = TRUE)\n# \n# install.packages(\n#   \"INLA\",\n#   repos = c(getOption(\"repos\"), INLA = \"https://inla.r-inla-download.org/R/testing\"),\n#   dep = TRUE\n# )\n# https://www.r-inla.org/download-install\nlibrary(INLA)\nlibrary(inlabru)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ninla.setOption(inla.mode = 'experimental')\n```\n:::\n\n\n### Generación grilla espacial y modelo Matern SPDE \n\n\n::: {.cell}\n\n```{.r .cell-code}\nloc <- st_coordinates(datos_sf)\n\nmesh <- INLA::inla.mesh.2d(\n  loc = loc,\n  offset = c(1000, 4000),\n  cutoff = 800,\n  max.edge = c(1000, 2000),\n  max.n = 10000)\n\n\nggplot(datos_sf) +\n  gg(mesh) +\n  geom_sf()\n```\n\n::: {.cell-output-display}\n![](Ej01_files/figure-html/generacion-grilla-inla-1.png){width=672}\n:::\n\n```{.r .cell-code}\nspde <- INLA::inla.spde2.pcmatern(\n  mesh = mesh,\n  prior.range = c(2000, 0.05),\n  prior.sigma = c(200, 0.01)\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Ajuste MJB usando INLA sin funciones de inlabru\"}\nproj_obs <- inla.mesh.projector(mesh, loc = loc)\nproj_pred <- inla.mesh.projector(mesh, loc = mesh$loc)\n\nA_obs <- inla.spde.make.A(mesh, loc = loc)\nA_pred <- inla.spde.make.A(mesh, loc = proj_pred$loc)\nidx <- 1:spde$n.spde\n\nstack_obs <-\n  inla.stack(\n    data = list(y = datos_sf$TCH),\n    A = list(A_obs, 1),\n    effects = list(c(\n      list(Intercept = 1),\n      inla.spde.make.index(\"spatial\", spde$n.spde)\n    ),\n    covar = datos_sf$ndvi),\n    tag = \"obs\"\n  )\nstack_pred <-\n  inla.stack(\n    data = list(y = NA),\n    A = list(A_pred),\n    effects = list(c(\n      list(Intercept = 1),\n      inla.spde.make.index(\"spatial\", mesh$n)\n    )),\n    tag = \"pred\"\n  )\nstack <- inla.stack(stack_obs, stack_pred)\n\n\nformula <- y ~ -1 + Intercept + covar +\n    f(spatial, model = spde)\n\nresult1 <- inla(\n  formula,\n  data = inla.stack.data(stack_obs, spde = spde),\n  family = \"gaussian\",\n  control.predictor = list(A = inla.stack.A(stack_obs),\n                           compute = TRUE)\n)\nsummary(result1)\n\n\nplot(datos_sf$TCH, \n     result1$summary.fitted.values[inla.stack.index(stack_obs, \"obs\")$data, \"mean\"],\n     main = \"Observations vs posterior predicted values at the data locations\")\n\n# \n# field_pred <- inla.mesh.project(proj_pred,\n#                                 result1$summary.fitted.values[inla.stack.index(stack, \"pred\")$data, \"mean\"])\n# field_pred_sd <- inla.mesh.project(proj_pred,\n#                                    result1$summary.fitted.values[inla.stack.index(stack, \"pred\")$data, \"sd\"])\n# \n# image(inla.mesh.project(mesh,\n#                         field = field_pred,\n#                         dims = c(200, 200)),\n#       main = \"Posterior field mean\")\n# image(inla.mesh.project(mesh,\n#                         field = field_pred_sd,\n#                         dims = c(200, 200)),\n#       main = \"Prediction standard deviation\")\n```\n:::\n\n\n\n## Ajuste de MJB con `inlabru`\n\nEl paquete `inlabru` fue desarrollado para facilitar la modelación espacial \nutilizando funciones del paquete `INLA`.\n\n\n::: {.cell .column-page-right layout-align=\"center\"}\n\n```{.r .cell-code}\nndvi_bru_spde <-\n  bru(\n    TCH ~ Intercept(1) + ndvi + site(main = coordinates, model = spde),\n    family = \"gaussian\",\n    data = as_Spatial(datos_sf)\n  )\n\nsummary(ndvi_bru_spde)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n## inlabru version: 2.10.0\n## INLA version: 23.11.01\n## Components:\n## Intercept: main = linear(1), group = exchangeable(1L), replicate = iid(1L)\n## ndvi: main = linear(ndvi), group = exchangeable(1L), replicate = iid(1L)\n## site: main = spde(coordinates), group = exchangeable(1L), replicate = iid(1L)\n## Likelihoods:\n##   Family: 'gaussian'\n##     Data class: 'SpatialPointsDataFrame'\n##     Predictor: TCH ~ .\n## Time used:\n##     Pre = 0.678, Running = 6.91, Post = 0.293, Total = 7.88 \n## Fixed effects:\n##             mean     sd 0.025quant 0.5quant 0.975quant   mode kld\n## Intercept 31.289 16.672     -1.378   31.275     64.031 31.272   0\n## ndvi      79.875 24.905     30.876   79.935    128.531 79.936   0\n## \n## Random effects:\n##   Name\t  Model\n##     site SPDE2 model\n## \n## Model hyperparameters:\n##                                             mean       sd 0.025quant 0.5quant\n## Precision for the Gaussian observations    0.012    0.005      0.005    0.011\n## Range for site                          6684.994 3335.229   2675.742 5911.663\n## Stdev for site                            16.257    3.379     10.532   15.945\n##                                         0.975quant    mode\n## Precision for the Gaussian observations   2.20e-02    0.01\n## Range for site                            1.54e+04 4658.43\n## Stdev for site                            2.38e+01   15.38\n## \n## Deviance Information Criterion (DIC) ...............: 617.58\n## Deviance Information Criterion (DIC, saturated) ....: 122.31\n## Effective number of parameters .....................: 41.90\n## \n## Watanabe-Akaike information criterion (WAIC) ...: 618.18\n## Effective number of parameters .................: 33.36\n## \n## Marginal log-Likelihood:  -346.81 \n##  is computed \n## Posterior summaries for the linear predictor and the fitted values are computed\n## (Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')\n```\n:::\n:::\n\n::: {.cell .column-screen-inset-shaded layout-nrow=\"1\"}\n\n```{.r .cell-code}\nplot(ndvi_bru_spde, \"Intercept\")\n```\n\n::: {.cell-output-display}\n![](Ej01_files/figure-html/unnamed-chunk-25-1.png){width=672}\n:::\n\n```{.r .cell-code}\nplot(ndvi_bru_spde, \"ndvi\")\n```\n\n::: {.cell-output-display}\n![](Ej01_files/figure-html/unnamed-chunk-25-2.png){width=672}\n:::\n:::\n\n\n- Distribución a posteriori de los hiperparámetros\n\n\n::: {.cell}\n\n```{.r .cell-code}\nspde.posterior(ndvi_bru_spde, \"site\", what = \"matern.covariance\") -> covplot\nspde.posterior(ndvi_bru_spde, \"site\", what = \"matern.correlation\") -> corplot\nspde.posterior(ndvi_bru_spde, \"site\", what = \"range\") -> rngplot\nspde.posterior(ndvi_bru_spde, \"site\", what = \"log.range\") -> lgrngplot\nspde.posterior(ndvi_bru_spde, \"site\", what = \"variance\") -> varplot\nspde.posterior(ndvi_bru_spde, \"site\", what = \"log.variance\") -> lgvarplot\n\nmultiplot(plot(covplot), plot(corplot),\n          plot(rngplot), plot(lgrngplot),\n          plot(varplot), plot(lgvarplot))\n```\n\n::: {.cell-output-display}\n![](Ej01_files/figure-html/unnamed-chunk-26-1.png){width=672}\n:::\n:::\n\n\n\n#### Observados vs. distribución a posteriori\n\n\n::: {.cell}\n\n```{.r .cell-code}\npred_mesh <-\n  predict(ndvi_bru_spde, as_Spatial(datos_sf), ~ Intercept + ndvi + site)\npredichos <- st_as_sf(pred_mesh)\n\nggplot(predichos, aes(mean, TCH)) +\n  geom_point() +\n  geom_abline(slope = 1, intercept = 0)\n```\n\n::: {.cell-output-display}\n![](Ej01_files/figure-html/unnamed-chunk-27-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Predicción espacial de TCH\"}\n# No aplica para esta aplicación.\n# pred_mesh <-\n#   predict(ndvi_bru_spde, pixels(mesh), ~ Intercept + ndvi + site)\n# \n# ggplot() +\n#   gg(pred_mesh)\n# ggplot(datos_sf) +\n#   gg(pred_mesh) +\n#   gg(mesh) +\n#   geom_sf()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npredichos_lm$pred_ndvi_inla <- predichos$mean\n\nggplot(predichos_lm, aes(pred_ndvi_iid, TCH)) +\n  geom_point() +\n  geom_abline(slope = 1, intercept = 0)\n```\n\n::: {.cell-output-display}\n![](Ej01_files/figure-html/unnamed-chunk-29-1.png){width=672}\n:::\n\n```{.r .cell-code}\nggplot(predichos_lm, aes(pred_ndvi_esp, TCH)) +\n  geom_point() +\n  geom_abline(slope = 1, intercept = 0)\n```\n\n::: {.cell-output-display}\n![](Ej01_files/figure-html/unnamed-chunk-29-2.png){width=672}\n:::\n\n```{.r .cell-code}\nggplot() +\n  geom_point(data = predichos_lm, \n             aes(pred_ndvi_iid, TCH, color = 'REML iid')) +\n  geom_point(data = predichos_lm, \n             aes(pred_ndvi_esp, TCH, color = 'REML Corr')) +\n  geom_point(data = predichos_lm, \n             aes(pred_ndvi_inla, TCH, color = 'INLA Corr')) +\n  geom_abline(slope = 1, intercept = 0) +\n  labs(x = 'TCH Predichos', y = 'TCH Observado', color = 'Estimación')\n```\n\n::: {.cell-output-display}\n![](Ej01_files/figure-html/unnamed-chunk-29-3.png){width=672}\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}